generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  role      String   @default("admin") // admin, barber, customer
  phone     String?
  avatar    String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resetPasswordToken   String?   @unique
  resetPasswordExpires DateTime?

  // âœ… CAMPOS DE ACEITAÃ‡ÃƒO DE TERMOS (LGPD) - BARBEIROS
  termsAccepted      Boolean   @default(false)
  termsAcceptedAt    DateTime?
  privacyAccepted    Boolean   @default(false)
  privacyAcceptedAt  DateTime?
  termsVersion       String?   // ex: "v1.0"
  privacyVersion     String?   // ex: "v1.0"

  // âœ… NOVO: PreferÃªncias do usuÃ¡rio (notificaÃ§Ãµes, tema, etc)
  preferences Json? @default("{\"emailNotifications\":true,\"smsNotifications\":false,\"whatsappNotifications\":true,\"theme\":\"light\"}")

  // âœ… NOVO FASE 5: Percentual de comissÃ£o (padrÃ£o 40%)
  commissionPercentage Float @default(40)

  tutorialCompleted Boolean @default(false)
  tutorialStep      Int?    @default(0)
  tutorialSkipped   Boolean @default(false)

  barbershop   Barbershop? @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  barbershopId String?

  appointments    Appointment[]
  servicesProvided Service[]
  commissions     Commission[] // âœ… NOVO: ComissÃµes do barbeiro
  
  @@map("users")
}

model Barbershop {
  id          String   @id @default(uuid())
  name        String
  email       String   @unique
  phone       String
  address     String?
  city        String?
  state       String?
  logo        String?
  plan        String   @default("trial") // trial, basic, premium, enterprise
  planStatus  String   @default("active") // active, cancelled, suspended
  trialEndsAt DateTime? // Data fim do trial
  planStartedAt DateTime @default(now())
  planExpiresAt DateTime? // Data de renovaÃ§Ã£o
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Limites do plano
  maxBarbers   Int @default(1)
  maxCustomers Int @default(100)

  // ðŸ†• NOVOS CAMPOS DA FASE 3 (ConfiguraÃ§Ãµes)
  zipCode     String?
  cnpj        String?
  description String? @db.Text

  // ===== CAMPOS DA LANDING PAGE (FASE 2) =====
  heroImage         String?
  heroTitle         String?
  heroSubtitle      String?
  galleryImages     String[] @default([])
  businessHours     Json?
  instagramUrl      String?
  facebookUrl       String?
  whatsappNumber    String?
  youtubeUrl        String?
  primaryColor      String?  @default("#2563eb")
  secondaryColor    String?  @default("#7c3aed")
  showTeam          Boolean  @default(true)
  showGallery       Boolean  @default(true)
  showReviews       Boolean  @default(true)
  allowOnlineBooking Boolean @default(true)

  neighborhood  String?
  number        String?
  complement    String?
  latitude      Float?
  longitude     Float?

  users        User[]
  services     Service[]
  appointments Appointment[]
  customers    Customer[]
  subscriptions Subscription[]
  transactions  Transaction[] // âœ… NOVO: TransaÃ§Ãµes financeiras
  commissions   Commission[]  // âœ… NOVO: ComissÃµes
  goals         Goal[]        // âœ… NOVO: Metas
  
  @@map("barbershops")
}

// âœ… NOVO: Model de TransaÃ§Ãµes Financeiras (Receitas e Despesas)
model Transaction {
  id            String   @id @default(uuid())
  barbershopId  String
  type          String   // 'income' ou 'expense'
  category      String   // 'service', 'product', 'salary', 'rent', 'commission', 'other'
  description   String
  amount        Decimal  @db.Decimal(10, 2)
  date          DateTime
  paymentMethod String?  // 'cash', 'pix', 'credit', 'debit'
  status        String   @default("completed") // 'completed', 'pending', 'cancelled'
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  barbershop Barbershop @relation(fields: [barbershopId], references: [id], onDelete: Cascade)

  @@map("transactions")
}

// âœ… NOVO: Model de ComissÃµes dos Barbeiros
model Commission {
  id             String   @id @default(uuid())
  barberId       String
  barbershopId   String
  percentage     Float    // 30, 40, 50, etc
  amount         Decimal  @db.Decimal(10, 2)
  referenceMonth DateTime // MÃªs/ano de referÃªncia
  status         String   @default("pending") // 'pending', 'paid'
  paidAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  barber     User       @relation(fields: [barberId], references: [id], onDelete: Cascade)
  barbershop Barbershop @relation(fields: [barbershopId], references: [id], onDelete: Cascade)

  @@map("commissions")
}

// âœ… NOVO: Model de Metas Financeiras
model Goal {
  id            String   @id @default(uuid())
  barbershopId  String
  name          String
  targetAmount  Decimal  @db.Decimal(10, 2)
  currentAmount Decimal  @db.Decimal(10, 2) @default(0)
  startDate     DateTime
  endDate       DateTime
  status        String   @default("active") // 'active', 'completed', 'cancelled'
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  barbershop Barbershop @relation(fields: [barbershopId], references: [id], onDelete: Cascade)

  @@map("goals")
}

model Subscription {
  id                String   @id @default(uuid())
  barbershopId      String
  plan              String   // basic, premium, enterprise
  status            String   @default("active") // active, cancelled, suspended, past_due
  amount            Decimal  @db.Decimal(10, 2)
  paymentMethod     String?  // credit_card, pix, boleto
  externalId        String?  // ID do gateway de pagamento
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelledAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  barbershop Barbershop @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  payments   Payment[]

  @@map("subscriptions")
}

model Payment {
  id             String   @id @default(uuid())
  subscriptionId String
  amount         Decimal  @db.Decimal(10, 2)
  status         String   @default("pending") // pending, paid, failed, refunded
  paymentMethod  String   // credit_card, pix, boleto
  externalId     String?  // ID do gateway
  paidAt         DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Service {
  id           String   @id @default(uuid())
  name         String
  description  String?
  price        Decimal  @db.Decimal(10, 2)
  duration     Int      // em minutos
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  barbershop   Barbershop @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  barbershopId String

  barber   User?   @relation(fields: [barberId], references: [id], onDelete: SetNull)
  barberId String?

  appointments Appointment[]
  
  @@map("services")
}

model Customer {
  id        String   @id @default(uuid())
  name      String
  email     String?
  phone     String
  birthDate DateTime?
  notes     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  barbershop   Barbershop @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  barbershopId String

  appointments Appointment[]
  
  @@map("customers")
}

model Client {
  id         String    @id @default(uuid())
  name       String
  email      String    @unique
  phone      String?
  password   String?
  avatar     String?
  birthDate  DateTime?
  active     Boolean   @default(true)
  googleId   String?   @unique
  facebookId String?   @unique
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  resetPasswordToken   String?   @unique
  resetPasswordExpires DateTime?

  // âœ… CAMPOS DE ACEITAÃ‡ÃƒO DE TERMOS (LGPD) - CLIENTES
  termsAccepted      Boolean   @default(false)
  termsAcceptedAt    DateTime?
  privacyAccepted    Boolean   @default(false)
  privacyAcceptedAt  DateTime?
  termsVersion       String?   // ex: "v1.0"
  privacyVersion     String?   // ex: "v1.0"

  appointments Appointment[]
  
  @@map("clients")
}

model Appointment {
  id        String   @id @default(uuid())
  date      DateTime
  status    String   @default("scheduled") // scheduled, confirmed, completed, cancelled
  notes     String?
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  barbershop   Barbershop @relation(fields: [barbershopId], references: [id], onDelete: Cascade)
  barbershopId String

  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  customerId String?

  client     Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  clientId   String?

  barber   User @relation(fields: [barberId], references: [id], onDelete: Cascade)
  barberId String

  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  serviceId String
  
  @@map("appointments")
}
